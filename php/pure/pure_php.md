## 学ぶこと

- この学習で学ぶことは HTML や CSS ではありません
  - 今回 Tailwind というものを使用してますが CDN というのを利用してます。なのでネット環境がないと style があたりません
- PHP による Database への処理や Form の処理について簡易アプリケーションという形で学びます

# CRUD 機能を持つ簡易アプリケーションの作成を行います

## 処理フロー

1. 一覧にて登録されている情報を表示させる
2. 新規登録 Form を作成し登録を行える様にする

- Validation(バリデーション)という機能を作成し、入力を必ずしてもらう形にします

3. 登録した内容を編集できる様にする

- Validation(バリデーション)という機能を作成し、入力を必ずしてもらう形にします

4. 登録した内容を削除できる様にする

## 用意されているもの

1. 一覧ページ
2. docker-compose.yml

- 今は、細かいことは知らなくていいです。DB を PC にいれなくてもローカル環境にて DB の利用を可能にしています。

## 用意してもらうもの

1. PHP の動作が行える環境

- Mac ならデフォルトで入っていますので問題ありません。
- Windows の方は WSL を利用していただければ Mac と同等の環境を構築することが可能です。

2. VSCode

- 私も使用している IDE です。こちらで作業していただくことを推奨します

3. ブラウザ

- Chrome を推奨します。
- fire fox などでも問題ありませんが動作等は Chrome でしか確認してません

## 前提

- 学ぶことを参照してください


## 準備

- ターミナルを開いてください
- []{}をgit cloneしてください
- Dockerを導入してしましょう
  - [Download URL]()
  - Dockerを起動します
- git cloneしたディレクトリにて下記コマンドを実行しましょう
  - `docker-composer up -d`
  - このコマンドを実行したことでDBが作成されます
- ログみたいなものが出力されなくなったら`docker-compose ps`を実行してください。UPの文字が確認できたら成功です


## Part 1

### 新規登録を完成させよう

- PHP は、何かを DB に登録したり取得したりすることができる言語です。
  - DB とは？は割愛させてもらいます。→ 　[参照](https://qiita.com/matsukei/items/9dfae2df9e7e3aa4ecd2)

すでに Form事態は存在してます。こちらに何かを入力して、登録ボタンを押すとページは遷移しませんがリクエストが飛びます。

試しにどんなふうにデータが飛んでいるか確認しましょう。

まずはHTMLタグの上に下記のように書きましょう
```php
<?php
var_dump($_POST);
?>
```

早速何かしら入力して「登録」ボタンを押下しましょう

ページ上部に入力された内容が表示されましたでしょうか？
表示されたら問題ありません。

Formタグに括られたHTMLのInput(typeは色々あります)に入力されたものは、指定したURLにデータがリクエストとして送られます。

私たちWeb業界のエンジニアが主に使用する`HTTP Method`は主に以下です。
```text
GET // データの取得等に関しては主にこちらになり、1番よく使われます
POST // データの新規作成
PUT // データの更新時に使用します
DELET // 原則として使うことは稀です。理由はデータを物理的に削除する(DB上から)ということが稀だから使用頻度はかなり低いです
```

今回FormタグのMethod属性に書かれているのは`POST`です。
理由は、上記一覧に書かれている新規作成の為`POST`にしてます。

PHPでPOSTで送られたデータは、`$_POST`で取得が可能です。

そのため今回入力されたデータの取得を行うのに使用しました。

Formタグの動きがわかりましたでしょうか？

Formタグによって送られたデータをDBに格納していきたいと思います

## Part 2
DB接続の設定を書き、データをDBに入れたいのですがDBに対しての基本的な操作を覚えましょう

今回作成するアプリケーションではdockerのDBに対して接続を行います。
現状DBを操作する方法がDBにコマンド絵直接アクセスする以外ありません

なのでGUI(所謂アプリケーション、以下クライアントアプリと呼びます)を使用して操作しましょう
有名なアプリケーションですと`Sequel Pro`という無償で使えるものが存在してますのでダウンロードしましょう

クライアントアプリにて接続を行います。
接続先情報は以下になります。

```test
Host : 127.0.0.1
Port : 3306
User : root
Password : root
```
接続テストのボタンが存在してますので接続テストしましょう。
成功したら早速アクセスしてみてください

今回使用するDBは、`test`というものになりますので選択してください

使用したらすでに`table`が存在しているかと思います

そちらクリックしてみましょう。
このTableにデータが格納されていきます

## Part 3

DBに関して少し知れたので実際にDBにデータを入れていきたいと思います

そのためにまずはPHPでDBへ接続するために設定を書きます

手法は、何種類か存在していますが今回は`new PDO()`というPHPの組み込み関数をします。

なぜこちらを使用するかと言いますと接続先のDBの種類が変わっても簡単な修正で対応が可能です
(今回は、Mysqlを使用します。また別のDBを使用することはありません)

では早速書いていきたいと思います。

```php
$dsn = 'mysql:dbname=shop;host=127.0.0.1';
$user = 'root';
$password = 'root';

try {
    $db  = new PDO($dsn, $user, $password);
} catch (PDOException $e) {
    echo "接続に失敗しました：" . $e->getMessage() . "\n";
    exit();
}
```

上記のように`HTML`タグの上($_POSTを書いたPHPタグの中)に書いてください。
これで接続が可能になってます。
コードの説明を簡潔に行います。

最初の方に書かれている文字列は、DBに接続するための接続先情報となります。

- try catch

エラーハンドリングを行うためによく使う構文となります。
今回ですと`new PDO()`というclassをインスタンス化してます。
引数を渡してインスタンス化を行っていますが失敗することがあります。

例えば、DB自体が起動していない場合、DBの接続先情報が正しくても接続することが難しい状態になります。

その際、PDOクラスは、Exceptionというエラー(例外)を出力します。

エラー内容は、まちまちですが例でいうと「DBに接続できません」と英語で出力されます。

このエラーをハンドリング(対応)します。その方法としてこの構文を使用してます。

catchに括弧ないにある`PDOException`がそれに当たります。

このエラーには、なぜエラーになったかのメッセージが含まれます。
なのでどうしてエラーになったか知るためにはちゃんとエラーを検知して対応を行う必要があります。

この書き方は、基本的な書き方になり、他のプログラミング言語でも見かけます。

またこのtry catchの使用に関しては、一つの方法なので必ずしも使うか言われるとそうではありません。

この先学ぶLaravelでは、try catchを使う場合と使わない場合があります。

またこれは実装方針によっても変わってきますので、一つの方法として覚えておきましょう！



## Part 4

DBに接続するための記述を行いました。

PDOクラスをインスタンス化ができたら接続された状態のオブジェクトが変数に格納されています
 
(少しわかりづらい文章になってますが、DBに接続している状態が変数に格納されているからその変数を使うことでDBに対しての操作が可能なんだなと認識していただけると)

この変数を使用して、DBに対してデータを格納する処理を書いていきます。

ここでは、DBに対して操作するための言語であるSQLに関しては、
基礎のみしか学びません。

またこの簡易アプリケえーションを作成する過程で学べるSQLは以下です

```sql
SELECT * FROM Table_Name;
INSERT INTO Table_Name (column1, column2) values (value1, value2);
UPDATE Table_Name SET column1 = value1; 
```

基本的な`SELECT`, `INSERT`, `UPDATE`の3個が出てきます。

SQLは、奥が深く上記のような簡潔なSQLを書くことはほとんど稀です。

この先で学ぶLaravelでは、複雑なSQLが書く必要がある処理だったとしてもORMというDBに対しての処理をよしなにやってくれるライブラリを使用しますのでLaravelを使用する実装者は、直感的に処理を書くことができます。



では実際にFormから送られてきたデータをDBに格納する処理を書いていきましょう

また大前提としてSQLインジェクションという攻撃を受けないためにFormのデータを検証した上でDBに格納したいと思います。

※SQLインジェクションについての説明は、割愛します

そのため今回はPDOクラスが用意している以下のメソッドを使用して処理を書きます

```
prepare() // クエリの実行準備を行うメソッド
↓
bindValue() // クエリ内の値の設定を行うメソッド
↓
execute() // クエリを実行するメソッド
```

この処理の流れで書くことによってSQLインジェクションを防ぐことができます。

